name: Node App CI

on:
 pull_request:
    types: [opened, reopened]
    branches: [develop, master]
    # paths:
    #   - 'nodeapp/**'
    
env:
  NODE_VERSION: '16.x'


jobs:

  Job1-Build-NodeApp:
    name: Node App
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: nodeapp
    
    steps:

    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Detect File changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          src:
            - 'nodeapp/**'

    - name: Exit Workflow if Node App has no changes
      if: steps.changes.outputs.src == 'false'
      run: exit 1
      
    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ env.NODE_VERSION }}
       
    - name: Install App dependencies
      run: npm ci

    - name: Run Unit Tests
      id: runtests
      run: npm test
      env:
          CI: true

    - name: Deploy Test Report to GitHub Page
      # if: ${{ failure() }}
      if: ${{ always() && steps.runtests.outcome == 'failure' }}
      # if: steps.runtests.outcome == 'failure'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.SEMANTIC_TOKEN }}
        publish_dir: ./nodeapp/reports
        publish_branch: gh-pages

    - name: Do other steps
      run: echo "Do other steps here..."

    # - name: Dump context
    #   uses: crazy-max/ghaction-dump-context@v1
  
  Job2-Create-Issue:
    name: Create Issue
    runs-on: ubuntu-latest
    needs: [Job1-Build-NodeApp]

    steps:

    - name: Do other steps
      run: echo "Do other steps here..."

    - name: Dump context
      uses: crazy-max/ghaction-dump-context@v1

  # Job2-Create-Issue:
  #   name: Create Issue
  #   runs-on: ubuntu-latest
  #   if: ${{ always() && contains(join(needs.*.result, ','), 'failure') }}
  #   needs: [Job1-Build-NodeApp]

  #   steps:
  #   - name: Create Issue
  #     uses: nashmaniac/create-issue-action@v1.1
  #     with:
  #       title: Automated Issue from workflow
  #       token: ${{secrets.SEMANTIC_TOKEN}}
  #       assignees: ${{github.actor}}
  #       labels: test-failed
  #       body: "[Test Report is out.](https://creativehub2000.github.io/Project1/index.html)"
       
